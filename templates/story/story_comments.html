{% extends "base.html" %}
{% block content %}
<div class="container">
  <h3>Comments for "{{ story.title }}"</h3>

  <!-- Comments List -->
  {% for comment in comments %}
  <div class="card comment" id="comment-{{ comment.id }}">
    <div class="card-content">
      <p>
        <strong>{{ comment.username }}</strong> on {{ comment.created_at.strftime("%Y-%m-%d %H:%M") }}
      </p>
      <p class="comment-message">{{ comment.message }}</p>
    </div>
    {% if comment.user_id == user.id or user.role.name == 'admin' %}
    <div class="card-action">
      <button class="btn-small waves-effect waves-light" onclick="toggleEdit({{ comment.id }})">Edit</button>
      <form action="{{ url_for('story.delete_comment', comment_id=comment.id) }}" method="POST"
        style="display:inline-block;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
        <button type="submit" class="btn-small red waves-effect waves-light">Delete</button>
      </form>
    </div>
    <!-- Hidden Edit Form -->
    <div class="card-content edit-form" id="edit-form-{{ comment.id }}" style="display: none;">
      <form action="{{ url_for('story.edit_comment', comment_id=comment.id) }}" method="POST">
        <div class="input-field" style="margin-bottom: 0;">
          <input type="text" name="message" value="{{ comment.message }}" required>
          <label class="active">Edit your comment</label>
        </div>
        <button type="submit" class="btn-small waves-effect waves-light">Save</button>
        <button type="button" class="btn-flat" onclick="toggleEdit({{ comment.id }})">Cancel</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endfor %}

  <!-- Pagination Controls -->
  {% if pagination.has_prev or pagination.has_next %}
  <div class="center">
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="waves-effect"><a
          href="{{ url_for('story_views.story_comments', story_id=story.id, page=pagination.prev_num) }}">« Prev</a></li>
      {% else %}
      <li class="disabled"><a href="#!">« Prev</a></li>
      {% endif %}

      {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if page_num %}
      {% if page_num == pagination.page %}
      <li class="active"><a href="#!">{{ page_num }}</a></li>
      {% else %}
      <li class="waves-effect"><a href="{{ url_for('story_views.story_comments', story_id=story.id, page=page_num) }}">{{
          page_num }}</a></li>
      {% endif %}
      {% else %}
      <li class="disabled"><a href="#!">…</a></li>
      {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="waves-effect"><a
          href="{{ url_for('story_views.story_comments', story_id=story.id, page=pagination.next_num) }}">Next »</a></li>
      {% else %}
      <li class="disabled"><a href="#!">Next »</a></li>
      {% endif %}
    </ul>
  </div>
  {% endif %}

  <!-- New Comment Form at the End -->
  <div class="card">
    <div class="card-content">
      <span class="card-title">Add a Comment</span>
      <form action="{{ url_for('story.new_comment', story_id=story.id) }}" method="POST">
        <div class="input-field">
          <textarea id="comment-message" class="materialize-textarea" name="message" required></textarea>
          <label for="comment-message">Enter your comment here</label>
        </div>
        <button type="submit" class="btn waves-effect waves-light">Post Comment</button>
      </form>
    </div>
  </div>

  <div class="section">
    <a href="{{ url_for('story_views.read_story', story_id=story.id) }}" class="btn-flat">Back to Story</a>
  </div>
</div>

<!-- JavaScript for toggling edit forms -->
<script>
  function toggleEdit(commentId) {
    var editForm = document.getElementById("edit-form-" + commentId);
    if (editForm.style.display === "none") {
      editForm.style.display = "block";
    } else {
      editForm.style.display = "none";
    }
  }
</script>
{% endblock %}